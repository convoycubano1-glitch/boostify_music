name: ğŸš€ Multi-Campaign Email Warmup

on:
  schedule:
    # Ejecutar 5 veces al dÃ­a en horarios de oficina (EST/EDT)
    # Los emails se distribuyen naturalmente gracias a los delays en el script
    - cron: '0 14 * * *'   # 9:00 AM EST
    - cron: '0 16 * * *'   # 11:00 AM EST
    - cron: '0 18 * * *'   # 1:00 PM EST
    - cron: '0 20 * * *'   # 3:00 PM EST
    - cron: '0 22 * * *'   # 5:00 PM EST
  workflow_dispatch:
    inputs:
      campaigns:
        description: 'CampaÃ±as a ejecutar (ALL, INDUSTRY, ARTISTS_1, ARTISTS_2, ARTISTS_3, ARTISTS_4)'
        required: false
        default: 'ALL'
        type: string
      preview_mode:
        description: 'Modo preview (enviar a convoycubano@gmail.com)'
        required: false
        default: 'false'
        type: boolean

jobs:
  # Determinar quÃ© campaÃ±a ejecutar basado en la hora
  select-campaign:
    runs-on: ubuntu-latest
    outputs:
      campaign: ${{ steps.select.outputs.campaign }}
    steps:
      - name: ğŸ¯ Select campaign based on schedule
        id: select
        run: |
          HOUR=$(date -u +%H)
          echo "Current UTC hour: $HOUR"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "campaign=${{ github.event.inputs.campaigns }}" >> $GITHUB_OUTPUT
          elif [ "$HOUR" == "14" ]; then
            echo "campaign=INDUSTRY" >> $GITHUB_OUTPUT
          elif [ "$HOUR" == "16" ]; then
            echo "campaign=ARTISTS_1" >> $GITHUB_OUTPUT
          elif [ "$HOUR" == "18" ]; then
            echo "campaign=ARTISTS_2" >> $GITHUB_OUTPUT
          elif [ "$HOUR" == "20" ]; then
            echo "campaign=ARTISTS_3" >> $GITHUB_OUTPUT
          elif [ "$HOUR" == "22" ]; then
            echo "campaign=ARTISTS_4" >> $GITHUB_OUTPUT
          else
            echo "campaign=ALL" >> $GITHUB_OUTPUT
          fi
          
          echo "Selected campaign: $(cat $GITHUB_OUTPUT | grep campaign | cut -d= -f2)"

  warmup-emails:
    runs-on: ubuntu-latest
    needs: select-campaign
    environment: production
    
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      SUPABASE_CONNECTION_STRING: ${{ secrets.SUPABASE_CONNECTION_STRING }}
      RESEND_API_INDUSTRY: ${{ secrets.RESEND_API_INDUSTRY }}
      RESEND_API_ARTISTS_1: ${{ secrets.RESEND_API_ARTISTS_1 }}
      RESEND_API_ARTISTS_2: ${{ secrets.RESEND_API_ARTISTS_2 }}
      RESEND_API_ARTISTS_3: ${{ secrets.RESEND_API_ARTISTS_3 }}
      RESEND_API_ARTISTS_4: ${{ secrets.RESEND_API_ARTISTS_4 }}
      APIFY_API_INDUSTRY: ${{ secrets.APIFY_API_INDUSTRY }}
      APIFY_API_ARTISTS_1: ${{ secrets.APIFY_API_ARTISTS_1 }}
      APIFY_API_ARTISTS_2: ${{ secrets.APIFY_API_ARTISTS_2 }}
      APIFY_API_ARTISTS_3: ${{ secrets.APIFY_API_ARTISTS_3 }}
      APIFY_API_ARTISTS_4: ${{ secrets.APIFY_API_ARTISTS_4 }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ¯ Display selected campaign
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ¯ CAMPAÃ‘A SELECCIONADA: ${{ needs.select-campaign.outputs.campaign }}"
        echo "â° Hora UTC: $(date -u +%H:%M)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: ğŸ“Š Check lead statistics
      run: node scripts/check-leads.cjs

    - name: ğŸš€ Send warmup emails - INDUSTRY
      if: ${{ needs.select-campaign.outputs.campaign == 'ALL' || needs.select-campaign.outputs.campaign == 'INDUSTRY' }}
      run: |
        echo "ğŸ“§ Ejecutando campaÃ±a INDUSTRY (boostifymusic.com)..."
        node scripts/warmup-sender-v2.cjs INDUSTRY
      continue-on-error: true

    - name: ğŸ¤ Send warmup emails - ARTISTS_1
      if: ${{ needs.select-campaign.outputs.campaign == 'ALL' || needs.select-campaign.outputs.campaign == 'ARTISTS_1' }}
      run: |
        echo "ğŸ“§ Ejecutando campaÃ±a ARTISTS_1 (boostifymusic.site)..."
        node scripts/warmup-sender-v2.cjs ARTISTS_1
      continue-on-error: true

    - name: ğŸ§ Send warmup emails - ARTISTS_2
      if: ${{ needs.select-campaign.outputs.campaign == 'ALL' || needs.select-campaign.outputs.campaign == 'ARTISTS_2' }}
      run: |
        echo "ğŸ“§ Ejecutando campaÃ±a ARTISTS_2 (boostifymusic.space)..."
        node scripts/warmup-sender-v2.cjs ARTISTS_2
      continue-on-error: true

    - name: ğŸµ Send warmup emails - ARTISTS_3
      if: ${{ needs.select-campaign.outputs.campaign == 'ALL' || needs.select-campaign.outputs.campaign == 'ARTISTS_3' }}
      run: |
        echo "ğŸ“§ Ejecutando campaÃ±a ARTISTS_3 (boostifymusic.sbs)..."
        node scripts/warmup-sender-v2.cjs ARTISTS_3
      continue-on-error: true

    - name: ğŸ¹ Send warmup emails - ARTISTS_4
      if: ${{ needs.select-campaign.outputs.campaign == 'ALL' || needs.select-campaign.outputs.campaign == 'ARTISTS_4' }}
      run: |
        echo "ğŸ“§ Ejecutando campaÃ±a ARTISTS_4 (boostifymusic.online)..."
        node scripts/warmup-sender-v2.cjs ARTISTS_4
      continue-on-error: true

    - name: ğŸ“ˆ Final statistics
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š RESUMEN FINAL"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        node scripts/check-leads.cjs
