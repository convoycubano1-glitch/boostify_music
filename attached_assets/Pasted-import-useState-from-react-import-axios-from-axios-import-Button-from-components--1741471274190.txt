import { useState } from 'react';
import axios from 'axios';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Sparkles, Loader2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

export function SimpleTryOnComponent() {
  const [modelImage, setModelImage] = useState(null);
  const [clothingImage, setClothingImage] = useState(null);
  const [resultImage, setResultImage] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const { toast } = useToast();

  const handleFileUpload = (event, setImage) => {
    const file = event.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      toast({
        title: "Tipo de archivo inválido",
        description: "Por favor, sube solo imágenes (JPG, PNG, etc.)",
        variant: "destructive",
      });
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => setImage(e.target.result);
    reader.readAsDataURL(file);
  };

  const { toast } = useToast();
  const [loading, setLoading] = useState(false);

  const checkTaskStatus = async (taskId) => {
    try {
      const statusResponse = await axios.post('/api/kling/try-on/status', { taskId });

      if (statusResponse.data.status === 'completed') {
        setResultImage(statusResponse.data.images[0].url || statusResponse.data.images[0]);
        setLoading(false);
        toast({ title: "¡Proceso completado!", description: "Imagen generada correctamente." });
      } else if (statusResponse.data.status === 'failed') {
        setLoading(false);
        throw new Error(statusResponse.data.errorMessage);
      } else {
        setTimeout(() => checkTaskStatus(taskId), 3000);
      }
    } catch (error) {
      setLoading(false);
      console.error('Error verificando estado:', error);
      toast({ title: "Error", description: error.message, variant: "destructive" });
    }
  };

  const handleStartTryOn = async () => {
    if (!modelImage || !clothingImage) {
      toast({ title: "Imágenes requeridas", description: "Debes subir ambas imágenes.", variant: "destructive" });
      return;
    }

    setLoading(true);
    setResultImage(null);

    try {
      const requestBody = {
        model: "kling",
        task_type: "ai_try_on",
        input: {
          model_input: modelImage,
          dress_input: clothingImage,
          batch_size: 1
        }
      };

      const response = await axios.post('/api/kling/try-on/start', requestBody);

      if (response.data.success && response.data.taskId) {
        toast({ title: "Proceso iniciado", description: "Imágenes procesándose. Espera un momento." });
        checkTaskStatus(response.data.taskId);
      } else {
        setLoading(false);
        throw new Error(response.data.error || "Error al iniciar el proceso");
      }
    } catch (error) {
      setLoading(false);
      console.error('Error iniciando Try-On:', error);
      toast({ title: "Error", description: error.message, variant: "destructive" });
    }
  };

  return (
    <div>
      <Input type="file" onChange={(e) => handleFileUpload(e, setModelImage)} />
      <Input type="file" onChange={(e) => handleFileUpload(e, setClothingImage)} />

      <Button onClick={handleStartTryOn} disabled={loading}>
        {loading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Sparkles className="mr-2 h-4 w-4" />} 
        {loading ? "Procesando..." : "Probar Virtualmente"}
      </Button>

      {resultImage && <img src={resultImage} alt="Resultado" className="mt-4" />}
    </div>
  );
}
