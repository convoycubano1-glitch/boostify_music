  /**
   * Convierte un archivo de imagen a formato JPEG optimizado para Kling API
   * 
   * Esta función utiliza nuestro método asíncrono unificado processImageForKling para garantizar:
   * - Formato JPEG exacto con encabezado "data:image/jpeg;base64,"
   * - Correcta validación de dimensiones, tamaño y estructura JPEG
   * - Optimización de calidad para mantener detalles mientras se cumple con requisitos
   * 
   * @param file Archivo de imagen a convertir
   * @param callback Función de retorno con la URL de datos JPEG o null si hay error
   */
  const convertImageToJpeg = (file: File, callback: (dataUrl: string | null) => void) => {
    console.log('Iniciando conversión a JPEG optimizada de:', file.name, 'tipo:', file.type, 'tamaño:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
    
    // Usamos un FileReader para obtener el dataURL inicial
    const reader = new FileReader();
    
    reader.onload = async (e) => {
      try {
        const sourceDataUrl = e.target?.result as string;
        
        if (!sourceDataUrl) {
          console.error('Error: No se pudo obtener datos del archivo');
          callback(null);
          return;
        }
        
        console.log('Imagen cargada, procesando para requisitos estrictos de Kling...');
        
        // Utilizamos la función unificada processImageForKling que maneja todas 
        // las validaciones y conversiones necesarias en un solo paso
        const processResult = await processImageForKling(sourceDataUrl);
        
        if (!processResult.isValid || !processResult.processedImage) {
          console.error('Error en el procesamiento de imagen:', processResult.errorMessage);
          toast({
            title: "Error de Procesamiento",
            description: processResult.errorMessage || "No se pudo procesar la imagen al formato requerido.",
            variant: "destructive",
          });
          callback(null);
          return;
        }
        
        // Obtener información de la imagen procesada para feedback
        const dimensions = processResult.width && processResult.height 
          ? `${processResult.width}x${processResult.height}`
          : 'dimensiones desconocidas';
        
        const size = processResult.sizeInMB 
          ? `${processResult.sizeInMB.toFixed(2)}MB`
          : 'tamaño desconocido';
        
        console.log(`Imagen procesada correctamente: ${dimensions}, ${size}`);
        
        // La imagen ya ha sido validada por processImageForKling
        console.log('Validación exitosa, imagen lista para enviar a Kling API');
        callback(processResult.processedImage);
      } catch (error) {
        console.error('Error en el proceso de conversión:', error);
        toast({
          title: "Error Inesperado",
          description: "Ocurrió un error inesperado al procesar la imagen. Por favor, intente con otra imagen.",
          variant: "destructive",
        });
        callback(null);
      }
    };
    
    reader.onerror = () => {
      console.error('Error al leer el archivo');
      toast({
        title: "Error de Archivo",
        description: "No se pudo leer el archivo seleccionado. Por favor, verifique que es una imagen válida.",
        variant: "destructive",
      });
      callback(null);
    };
    
    // Iniciamos la lectura como data URL
    reader.readAsDataURL(file);
  };